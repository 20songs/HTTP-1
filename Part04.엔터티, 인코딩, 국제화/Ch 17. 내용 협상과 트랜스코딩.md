# 4부 엔터티, 인코딩, 국제화

## Ch 17. 내용 협상과 트랜스코딩



### 서론

##### 내용 협상

* URL이 여러 리소스에 대응할 필요가 있는 경우
* 클라이언트와 서버 사이의 커뮤니케이션

##### 트랜스코딩

* 내용 협상의 응답의 일환
* 특정 URL에 대해 어떤 콘텐츠가 클라이언트에게 보내주기 가장 적절한지에 대한 판단



### 17.1. 내용 협상 기법

| 기법            | 결정                    | 장점                                                    | 단점                                                 |
| --------------- | ----------------------- | ------------------------------------------------------- | ---------------------------------------------------- |
| 클라이언트 주도 | 클라이언트              | 서버가 구현하기 쉬움<br />클라이언트는 최선의 선택 가능 | 대기 시간이 증가<br />최소 두 번의 요청 필요         |
| 서버 주도       | 서버                    | 빠르다                                                  | 요청 헤더에 맞는 것이 없으면<br />서버는 추측해야 함 |
| 투명            | 중간 장치(프락시, 캐시) | 빠르다<br />웹서버가 협상할 필요가 없다                 | 정형화 된 명세가 없음                                |



### 17.2. 클라이언트 주도 협상

* **협상 방법**

  * 1: URL 리소스 버전 링크와 설명이 담긴 HTML 페이지 제공

    > 사용자는 브라우저를 통해 선택

  * 2: 300 Multiple Choices 응답 코드로 HTTP/1.1응답 제공

* **장점**
  * 가장 구현하기 쉽고 최선의 사본이 선택된다는 장점이 있음

* **단점**
  * 각 페이지에 대해 두 번의 요청이 필요함
  * 느리고 지루한 과정
  * URL 리소스에 대한 북마크, 캐시 저장이 애매하다
    * www.joes-hardware.com
    * www.joes-hardware.com/english



### 17.3. 서버 주도 협상

* **협상 방법**
  * 클라이언트의 요청 헤더를 통해 서버가 결정할 정보를 얻음
* **메커니즘**
  * 1: 내용 협상 헤더를 살펴본 후 Accept 관련 헤더들을 들여다 봄
  * 2: 내용 협상 헤더 이외 헤더를 살펴봄

#### 17.3.1. 내용 협상 헤더 방식(요청)

* **헤더 종류**

  | 헤더            | 설명        |
  | --------------- | ----------- |
  | Accept          | 미디어 타입 |
  | Accept-Language | 언어 타입   |
  | Accept-Charset  | 차셋 타입   |
  | Accept-Encoding | 인코딩 타입 |

  > 마치 엔터티 헤더와 유사함
  >
  > Content-Type / Content-Language / Content-Type / Content-Encoding

* **품질값(q)의 사용**

  > 만약 사용자가 스페인 사람이며 서버는 영어, 불어의 페이지 소스만 가지고 있는 상황을 가정한다면, 서버가 추측할 수 밖에 없음.
  >
  > 따라서 요청 헤더에 q(quality value) 옵션을 사용하여 이를 보완

  `Accept-Language: en;q=0.5, fr;q=0.0, nl;q=1.0, tr;q=0.0`

  * q값은 0.0에서 1.0으로 높을 수록 선호한다는 의미로 해석
    * 네덜란드 언어를 가장 선호하며, 영어는 수용 가능하고 프랑스와 터키의 경우 응답으로 받아도 읽을 수 없다는 의미
  * 만약, 영어, 네덜란드 언어에 해당하는 리소스를 갖고 있지 않은 경우에 '트랜스코딩'을 이용할 수 있음

#### 17.3.2. 내용 협상 외 헤더 방식(요청) / 아파치 예시

> 예를 들어 자바스크립트를 지원하지 않는 User-Agent 값에 해당하는 경우, 자바 스크립트를 포함하지 않는 페이지를 돌려줄 수 있어야 한다

* **전제**

  * 콘텐츠 제공자는 각각의 버전에 해당하는 파일을 서버의 적절한 디렉터리에 포함해야 함

* **내용 협상 방식**

  * 1: 배리언트(varianat)를 갖는 웹 사이트의 URI를 위해 type-map 파일을 생성
    	type-map 파일은 모든 배리언트와 그들 각각에 대응하는 내용 협상 헤더를 나열
  * 2: MultiViews 지시어를 키면 자동으로 type-map 파일이 생성

* **type-map 파일 사용하기**

  * 서버 설정 파일에 type-map 파일들을 위한 파일 접미사를 명시하여 핸들러 추가

    `AddHandler type-map .var`

    * **.var** 확장자를 가진 파일  =  **type-map** 파일

    ```
    URI: joes-hardware.html
    
    URI: joes-hardware.en.html
    Content-type: text/html
    Content-language: en
    
    URI: joes-hardware.fr.de.html
    Content-type: text/html; charset=iso-8859-2
    Content-language: fr,de
    ```

* **MultiViews 사용하기**
  * `access.conf > (<Directory>, <Location>, <Files>)`
    * Options 지시어를 이용해서 웹 사이트를 포함한 디렉터리에 Multiviews를 켜야 함
  * 모든 파일을 살펴본 후 그에 대한 type-map을 자동으로 생성함
  * 파일 이름에 근거하여 내용 협상 헤더를 추측함



### 17.4. 투명 협상(중개자, 프락시, 캐시)

* **장점**
  * 서버의 부하를 제거함
  * 클라이언트 주도에 비해 빠름
* **전제**
  * 서버가 Vary 헤더(응답)를 통해 중개자에게 내용 협상에 대한 프로세스 정보 전달

#### 17.4.1. 캐시

* **캐시를 통한 내용 협상 동작 방식**

  * 캐시가 모르는 최초의 요청에 대해 서버로 전달
  * 서버로 부터 온 응답을 저장
  * 같은 URL에 대한 여러 버전(Variant, 얼터네이트)을 저장

* **Vary 응답 헤더**

  * 클라이언트 요청 헤더 - 서버의 응답 헤더를 모두 저장하는 정보
    * 서버가 클라이언트 요청을 처리하는 로직에 포함되는 정보가 모두 저장되는 헤더
  * 캐시는 이 vary 헤더를 통해 응답을 결정함

  **`예시: Vary: User-Agent, Cookie`**

  * 이 경우, User-Agent,와 Cookie의 변화에 대해 서로 다른 Variant, Alternate를 저장하게 됨
  * 서버가 판단하듯 캐시도 Vary 헤더를 통해 클라이언트 요청을 해석하여 그에 맞는 정보를 전달해줌
  * 만약 맞는 것이 없다면 서버로부터 문서를 전달받음

* **트랜스코딩**

  * 캐시는 범용 트랜스코더가 설치된 경우 이를 통해 트랜스코딩한 문서를 전달할 수 있음



### 17.5. 트랜스코딩

> 클라이언트 요구에 가장 잘 맞는 것이 존재하지 않을 때 사용할 수 있는 옵션

* **예시**
  * HTML >> WML
  * 고해상도 >> 저해상도
  * 64K 색 >> 흑백
  * 광고가 없는 페이지 >> 광고가 있는 페이지

* **종류**
  * 포맷 변환
  * 정보 합성
  * 내용 주입

#### 17.5.1. 포맷 변환

* 용도
  * 클라이언트가 볼 수 있는 포뱃으로 변환해주는 역할
  * 모바일 단말기로 접속한 경우(User-Agent: mobile) 데스크톱 용 문서인 HTML이 아닌 WML 문서로 변환해 줄 필요가 있음
  * 이미지를 칼라에서 흑백으로 변환 및 축소하는 것도 포뱃 변환의 한 종류
* 방법
  * 주로 내용 협상 헤더에 의해 수행
    * User-Agent 헤더를 통해서 수행될 수도 있음
* 콘텐츠 인코딩, 전송 인코딩과 트랜스 코딩은 다른 역할을 한다는 것에 주의
  * 트랜스 코딩은 '효율성, 안전성'을 위한 것
  * 콘텐츠, 전송 인코딩의 경우 접근 가능성을 위한 것

#### 17.5.2. 정보 합성

> 정보의 요점을 추출하는 것

* 예시
  * 제목에 기반한 문서 개요 생성
  * 페이지에서 광고 및 로고 제거
  * 본문 키워드에 기반하여 페이지를 분류

#### 17.5.3. 콘텐츠 주입

* 예시
  * 자동 광고 생성
  * 사용자 추적 시스템
* 동작
  * 특정 사용자를 대상으로 하는 광고를 그때 그때 효과적으로 삽입하기 위해 동적으로 이루어짐
  * 사용자에게 어떻게 페이지가 보여지고 클라이언트가 웹을 돌아다니는 지 통계를 수집하기 위해 페이지에 동적으로 콘텐츠를 추가함

#### 17.5.4. 정적으로 미리 생성해놓기는 안된다

* 트랜스 코딩의 대안으로 여러 사본을 만들어 둘 수 있음
  * 그러나 현실적인 기법이 되지 못함
  * 사용자 맞춤 광고, 추적 시스템의 경우 정적 방법은 불가능
  * 페이지 저장을 위한 공간이 매우 많이 필요함
* 단, 트랜스 코딩의 경우 대기시간이 증가할 수 있음
  * 이를 해결하기 위해 중간자(프락시, 캐시)를 통해 웹 서버의 부담을 덜 수 있음



