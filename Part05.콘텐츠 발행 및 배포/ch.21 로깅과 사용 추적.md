# ch.21 로깅과 사용 추적

> 로깅

- 거의 모든 서버와 프락시는 처리했던 HTTP 트랜잭션을 요약해서 기록하는 것



## 21.1 로깅이란?

- 로깅을 하는 이유는 서버나 프락시의 문제를 찾거나, 
  웹 사이트 접근 통계를 내려기 위함이다.
- 다만, 모든 데이터를 그대로 로깅하면 감당하기 힘들어지기 때문에 
  별 연관성이 없고 다시 볼 일도 없는 데이터만 로깅한다.
- 로깅하는 필드로는
  - HTTP 메서드
  - 클라이언트와 서버의 HTTP 버전
  - 요청받은 리소스의 URL
  - 응답의 HTTP 상태 코드
  - 요청과 응답 메시지의 크기(모든 엔터티 본문을 포함)
  - 트랜젝션이 일어난 시간
  - Referer와 Use-Agent 헤더 값





## 21.2 로그 포멧

- 상용 혹은 오픈 소스 HTTP 애플리케이션은 
  대부분  표준 로그 포멧을 **한 개 이상 지원**한다.
- 애플리케이션이 더 많은 표준 포맷을 지원하고 관리자가 이것을 사용함으로
  **필요한 통계를 추출**할 수 있다.





### 21.2.1 일반 로그 포멧(Common Log Format)

- 요즘 사용하는 가장 일반적인 포맷
- 대부분의 상용 혹은 오픈 소스 서버는 이 포멧을 사용하게 설정 가능

- 일반 로그 포멧의 필드

  | 필드          | 설명                                                | 엔트리                    |
  | ------------- | --------------------------------------------------- | ------------------------- |
  | remotehost    | 요청한 컴퓨터의 호스트 명 혹은 IP주소               | 209.1.32.44               |
  | username      | ident 검색을 수행했다면 인증된 요청자의 사용자 이름 | <비어있음>                |
  | auth-username | 인증이 수행했다면, 인증된 요청자의 이름             | dg                        |
  | timestamp     | 요청 날짜와 시간                                    | 03/Oct/2020:12:16:00-0400 |
  | request-line  | HTTP 요청의 행을 그대로 기술                        | GET/HTTP/1.0              |
  | response-code | 응답으로 보내는 HTTP 상태코드                       | 200                       |
  | response-size | 응답 엔터티의 Content-length. 반환 않하면 0         | 1024                      |

  



### 21.2.2 혼합 로그 포맷(Combined Log Format)

- 많이 사용하는 또 다른 로그 포맷으로 **아파치** 같은 서버들이 지원한다.

- 추가된 2개의 필드를 제외하고 일반 로그 포맷과 동일

- 추가된 필드

  | 필드       | 설명                              | 값                                               |
  | ---------- | --------------------------------- | ------------------------------------------------ |
  | Referer    | Referer HTTP 헤더의 값            | http://www.joes-hard.com                         |
  | User-Agent | User-Agent Referer HTTP 헤더의 값 | 5.0:Mozilla/4.0(compatible; MSIE 5.0;Windows 98) |



### 21.2.3 넷스케이프 확장 로그 포맷

- NCSA 일반 로그 포맷에서 시작

- 프락시나 웹 캐시 같은 HTTP 애플리케이션과 연관 있는 여러 환경을 지원하려고 포맷을 확장



### 21.2.4 넷스케이프 확장 2 로그 포맷

- 확장 로그 포맷에서 HTTP 프락시와 웹 캐시 애플리이션과 관련이 더 많은 정보를 포함
- 추가된 필드들은 HTTP 클라이언트와 HTTP 프락시 애플리케이션 간의 통신을 
  설계하는 데 도움이 된다.



> 넷스케이프 애플리케이션은

- 출력될 로그의 포맷으로 관리자가 수정할 수 있는 유연한 로그 포맷을 포함한 
  다영한 로그 포맷을 가지고 있다.
  - 관리자는 추가적인 설정을 해서 로그에 기록할 
    유연한 로그 포맷 트랜잭션의 특정 부분을 선택하여 로그를 최적화 할 수 있다.
  - 다른 많은 프락시와 서버 역시 로그에서 특정 정보만 추출하는 기능을 제공한다.



### 21.2. 5 스쿼드(Squid) 프락시 로그 포맷

- 스쿼드 프락시 캐시는 웹 분야에서 권위 있는 프로젝트이다.
- 스쿼드는 수년간 오픈 소스 커뮤니티를 통해 확장 및 개선되어온 프로젝트이고
  이로 인해 스쿼드 애플리이션을 관리하는데 도움이 되는 수많은 도구들이 개발되었다.

- 많은 차세대 프락시 캐시들이 이러한 도구를 활용하려고 
  자체 로그 포맷으로 스쿼드 포맷을 적용했다.





## 21.3 적중 계량하기

- 원 서버는 결산을 하기 위해 상세 로그를 저장하고
  로깅은 클라이언트가 웹서버에 직접 방문했을 때 이런 것들을 추적하는데 유용하다.
- 하지만 클라이언트와 서버 사이에 있는 캐시로 인해
  클라이언트의 요청이 서버까지 오기 전에 캐시되어 있는 리소스로 처리되고 끝난다.
  - 원 서버에 오지 않더라고 정상적으로 처리 될 수 있어서
    클라이언트가 콘텐츠에 접근했다는 기록이 남지 않아 로그 파일에 누락이 발생시킨다.
  - 이러한 로그 데이터 유실을 막기 위해 어쩔 수 없이 중요한 페이지의 캐시를 파기한다.
  - 특정 콘텐츠가 캐시되지 않게 만들어서 해당 콘텐츠의 요청은 원 서버로 간다.
  - 이로 인해 서버는 리소스에 대한 접근을 로깅할 수 있다.
  - 하지만 응답 속도가 느려지고 원서버와 네트워크의 부하가 가중된다
- 적중 계랑 규약은 HTTP의 확장으로 
  캐시가 정기적으로 **캐시 접근 통계를 원 서버에 보고**하도록 한다.

- 다만 이는 완벽한 해결책은 아니라서 널리 구현되어 있거나 사용되는 규약은 아니다.



> 적중 계량 규약에서 사용되는 meter 헤더

- 캐시나 서버는 Meter 헤더에 사용량이나 보고에 관한 지시가를 기술할 수 있다.
- 프락시가 보내는 요청과 서버의 응답에 Meter 헤더가 추가로 기술되어 있다.
- 프락시는 적중 계량을 할 수 있다고 서버에게 알리고,
  서버는 프락시에게 적중 횟수를 요구한다.
  - 프락시는 서버에 속해 있는 리소스를 추적하기 시작한다.
  - 그리고 프락시는 서버에 리소스에 대한 재검사를 한다.
  - 프락시는 서버로 보내는 조건적 요청에 추적하고자 하는 리소스의 정보를 기술하다.





## 21.4 개인 정보 보호에 대해

- 실제 로깅은 서버와 프락시에서 수행하는 관리 기능이므로
  모든 것이 사용자의 트랜잭션에 적용된다.
- 많은 사용자들이 자신의 HTTP 트랜잭션이 로깅되고 있다는 것을 모를 수 있다.
- 관리자와 개발자는 그들이 읽는 정보를 통해 
  사용자에 대한 많은 정보를 모을 수 있다. 
- 따라서 로깅하는 웹 서버와 프락시는 최종 사용자의 개인 정보를 보호하는 데
  신경을 많이 써야 한다.
- 사무실에서 관리자가 직원을 추적할 때에는
  사람들의 트랜잭션을 감시하고 있다는 사실을 공지해야 한다. 
- 요약하자면,
  로깅은 관리자와 개발자에게 매우 유용한 도구이지만 
  로깅을 당하는 사용자들의 인지나 허가가 없으면 
  로깅이 사생활 침해가 된다는 것을 유념해야 한다. 