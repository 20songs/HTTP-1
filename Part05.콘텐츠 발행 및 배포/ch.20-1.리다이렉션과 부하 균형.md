# 5부 콘텐츠 발행 및 배포

## Ch 20. 리다이렉션과 부하 균형

### 서론

리다이렉션은 HTTP 메시지가 HTTP 이외의 많은 프로토콜을 거치기 때문에 반드시 필요한 기술이다. 보통 메시지가 프락시, 캐시, 서버 팜의 특정 웹 서버 중 어디에서 끝나는 지(목적지) 판별하기 위해 사용한다.



### 20.1 왜 리다이렉트인가?

HTTP 애플리케이션에서 필요한 3가지 기능

* 신뢰할 수 있는 HTTP 트랜잭션 수행
* 지연 최소화
* 네트워크 대역폭 절약

위와 같은 이유로 인해 웹 콘텐츠는 흔히 여러 장소에 배포된다. 이렇게 하면 장점이 있다.

1. 실패한 경우 다른 곳을 이용할 수 있다.
2. 클라이언트는 더 가까운 리소스에 접근할 수 있다.
3. 서버의 네트워크 혼잡도가 줄어든다.

리다이렉션은 부하 균형과 공존한다. 메시지가 부하를 공유하는 서버 중 하나에 전달될 때 리다이렉션이 사용되고 메시지의 부하를 분산시킬 수 있기 때문이다.



### 20.2 리다이렉트 할 곳

클라이언트에게 있어 `서버, 프락시, 캐시, 게이트웨이`는 모두 서버에 해당한다고 볼 수 있다. 이들은 모두 서버 특성을 갖고 있기 때문이다. 

웹 서버는 IP 별로 요청을 다루며 각각 최적의 웹 서버로 요청을 보낸다. 

프락시는 프로토콜별로 요청을 다루며 주 진입로의 트래픽이 어디로 향하든 근처에 있는 지름길(예: 캐시)로 빨아들이는 것과 같은 역할을 한다.

리다이렉션은 대체로 모든 곳에서 동작하지만 어떤 기술(프로토콜)들은 특정 종류의 종단(프락시, 캐시)만을 위해 특별히 설계되는 경우가 있다.



### 20.3 리다이렉션 프로토콜의 개요

**일반 리다이렉션**

| 메커니즘              | 동작 방식                                                    | 재 라우팅 근거                                      | 제한                                                  |
| --------------------- | ------------------------------------------------------------ | --------------------------------------------------- | ----------------------------------------------------- |
| HTTP 리다이렉션       | 1. 웹 서버로 향함<br />2. 최적의 웹 서버 선택                | 라운드 로빈 부하<br />회전 지연<br />최단 거리 선정 | 반드시 첫 번째 웹 서버가 <br />요청 부하를 다뤄야 함  |
| DNS 리다이렉션        | 1. URL 호스트 명<br />2. IP주소 결정                         | 라운드 로빈<br />회전 지연<br />최단거리            | DNS 서버 설정 필요                                    |
| 임의 캐스트 어드레싱  | 패킷을 가장 가까운 서버로 보냄                               | 라우터 최단거리                                     | 연관 패킷들이 다른 서버로 보내질 수도 있음 (주소충돌) |
| 아이피맥 <br />포워딩 | 스위치, 라우터가 패킷에게 MAc 주소 할당                      | 대역폭 절약<br />부하 균형                          | 한 홉 거리에 있어야 가능                              |
| IP주소<br />포워딩    | 리다이렉트 패킷의 아이피 주소를 프락시, 미러링 서버의 아이피 주소로 바꿈 | 대역폭 절약<br />부하 균형                          | 클라이언트의 IP 주소를<br />잃어버릴 수도 있음        |

**프락시 서버 리다이렉트**

| 메커니즘                          | 동작                                                        | 근거                                 | 제약                                                        |
| --------------------------------- | ----------------------------------------------------------- | ------------------------------------ | ----------------------------------------------------------- |
| 브라우저 설정                     | 브라우저가 프락시를 설정                                    | 대역폭 절약<br />부하 균형           | 브라우저 설정 능력                                          |
| 프락시 자동설정                   | PAC 파일을 통해<br />URL - 프락시 정보 획득                 | 대역폭 절약<br />부하 균형           | 브라우저가 <br />쿼리를 보내야 함                           |
| 웹 프락시 <br />자동발견 프로토콜 | PAC 파일에 대한 URL을 물어봄                                | 서버가 PAC 파일의<br /> URL을 결정   |                                                             |
| 웹 캐시 조직 프로토콜             | 라우터는 패킷 주소를 캡슐화<br />클라이언트 주소 잃지 않음  | 대역폭 절약<br />부하 균형           | WCCP를 지원하는 <br />브라우저 필요                         |
| 인터넷 캐시 프로토콜              | 형제 캐시 무리에게 질의                                     | 형제 혹은 부모 캐시로부터 콘텐츠 get | 캐시 적중이 아님에도 적중인 것처럼 동작 가능                |
| 캐시 배열 라우팅 프로토콜         | 콘텐츠가 분산되고 <br />캐시 무리가 하나의 큰 캐시처럼 동작 | ICP보다 빠름                         | CARP는 형제 관계 지원이 안됨<br />설정에 반드시 동의해야 함 |
| 하이퍼텍스트<br />캐싱 프로토콜   | 형제 캐시 무리에게<br />콘텐츠에 대해 질의 가능             | ICP 보다 빠름                        |                                                             |



### 20.4 일반적인 리다이렉션

### 20.4.1. HTTP 리다이렉션

클라이언트 요청에 대해 서버가 다른 곳으로 요청을 보내라고 주소와 함께 응답하는 방식

부하가 가장 적고 거리가 가까운 서버를 선택해 최선의 가용한 서버를 결정하는 방식

아래와 같은 단점이 존재함

* 결정하기 위해 페이지 자체를 제공하는 것만큼이나 많은 양의 처리가 필요함
* 두 번 왕복이 필요해 속도가 느림
* 리다이렉트 서버가 고장나면 사이트 마비



### 20.4.2. DNS 리다이렉션

도메인에는 여러 개의 IP 주소가 할당될 수 있다. DNS 분석자는 호스트 명을 받아 IP 주소로 반환할 때 어떤 알고리즘을 통해 결정한다.

#### DNS 라운드 로빈

서버 팜(farm), 하나의 도메인에 여러 개의 서버가 모여 있는 서버 팜을 요청이 들어올 때마다 순회하는 방식이다. 클라이언트의 지리적 위치나 서버의 현재 스트레스를 고려하지 않는 단순한 알고리즘이다. 

* DNS 클라이언트는 다중 주소 집합의 첫 번째 주소를 사용한다. 이 때 주소를 순환시키는 것이 DNS 라운드 로빈이다.
* 여러 클라이언트가 요청하는 경우에 부하 균형을 유지해준다.
* 하나의 클라이언트에 대해 보통 할당한 서버를 기억하여 DNS 룩업 비용을 줄이고 계속 대화하도록 선호하는 데, 이런 방식으로는 하나의 클라이언트 부하를 분산하지 못한다.

#### 부하 균형 알고리즘

리다이렉트를 할 때, 가장 로드가 적은 웹 서버를 제시한다.

#### 근접 라우팅 알고리즘

사용자의 위치에 근거하여 가장 가까운 웹 서버로 리다이렉트 메시지를 응답한다.

#### 결함 마스킹 알고리즘

네트워크의 건강 상태에 따라 피해야 하는 서버를 결정한다. 보통 여러 서버들 중 권위를 가진 DNS 서버가 모니터링 하여 DNS에 대한 IP 주소를 할당한다.



### 20.4.3. 임의 캐스트 어드레싱

서버가 라우터인 척 **백본 라우터**에게 본인이 가장 가까운 라우터라고 메시지를 보내는 방식을 통해 리다이렉트를 유도하는 방식이다. 백본 라우터는 패킷을 받은 경우 라우터의 최단 거리 특성을 이용해 해당 서버를 라우터로 인식하여 보내게 된다. 

반드시 서버는 '라우터의 언어'로 말해야 하고 라우터는 하나의 메시지에 대한 여러 패킷을 다른 주소로 보내지 않도록 주소 충돌을 다룰 수 있어야 한다. 이를 다루지 못하여 발생하는 문제를 라우팅 누수라고 한다. (패킷이 샌다는 의미이다.)



### 20.4.4. 아이피 맥 포워딩

레이어-2 장비인 스위치나 허브가 리다이렉트를 주도하는 방식이다. 일반적으로 이더넷 네트워크에서 HTTP는 데이터 패킷에 주소를 붙여서 보낸다. 이 때 출발지/목적지 주소와 TCP 포트 번호가 붙은 레이어-4 주소와 미디어 접근 컨트롤(Media Access Control, MAC)주소인 레이어-2 주소가 있다. 

레이어-2 장비의 역할은 특정 MAC 주소 패킷을 받아 해당 MAC 주소로 포워딩하는 것이다. 이 중 레이어-4를 이해하는 스위치는 레이어-4 정보(IP주소, TCP 포트번호)를 읽어 라우팅을 할 수 있다. 

예를 들면 80번 TCP 포트 번호인 경우의 웹 트래픽은 모두 캐시로 보낼 수 있다. 만약 캐시가 최신의 정보를 갖지 않으면 스위치는 해당 캐시(MAC6)로부터 최신 콘텐츠에 대한 요청을 원 서버로 전달하는 역할도 한다.

클라이언트, 허브, 스위치, 게이트웨이, 캐시, 프락시 모두 MAC이며 MAC 주소 포워딩(아이피 맥 포워딩)을 사용하려면 한 홉 거리에 있어야 한다.



### 20.4.5. 아이피 주소 포워딩

레이어 4 주소(TCP/IP address)를 검증하여 MAC 주소가 아닌 목적지 주소로 라우팅한다. 한 홉 거리라는 제한이 사라지며 레이어-3 종단(End-To-End) 인터넷 라우팅이 패킷을 올바른 위치로 보내준다.

단, 라우팅 대칭성 문제가 발생한다. 클라이언트가 연결을 맺은 스위치를 우회하여 응답이 제공되어야 하는 문제이다. 귀한 경로를 설정하기 위해 2가지 해결 방법이 있다.

1. 출발 IP 주소를 클라이언트가 아닌 스위치의 IP 주소로 바꾼다. 이 목적지와 출발지 주소 양쪽을 번역하는 아이피 전달 장치를 완전 NAT(네트워크 주소 변환)이라고 한다. 단, 이때 인증이나 결제가 필요한 클라이언트 정보가 사라진다.
2. 클라이언트 IP 주소를 남긴 경우에는 네트워크를 통제해 서버 - 클라이언트 사이의 직통 경로를 없도록 만들어야 한다. 이를 반(Half) NAT라고 한다.



### 20.4.6. 네트워크 구성요소 제어 프로토콜

SE: 웹 서버나 프락시 캐시 등 애플리케이션 계층 요청을 처리하는 서버 구성요소

NE: 라우터나 스위치 같은 아이피 패킷을 전달하는 네트워크 구성요소

NECP: NE(네트워크 구성요소)와 SE(서버 구성요소)가 대화하도록 도와주는 네트워크 구성요소 제어 프로토콜(Network Element Control Protocol, NECP)

NCEP 프로토콜에서 MAC 포워딩, GRE 캡슐화, NAT와 같은 방법을 제공한다. 

[p. 537 표]



### 20.5. 프락시 리다이렉션 방법

보안상의 이유나 접근성의 이유로 프락시, 캐시로 리다이렉트 해야 하는 경우가 발생한다. 웹 브라우저가 프락시로 가는 길을 아는 방법은 3가지이다.

1. 명시적 브라우저 설정
2. 동적인 자동 설정
3. 자연스럽게 가로채기



### 20.5.1. 명시적 브라우저 설정

대부분의 브라우저는 프락시 서버로 도달하기 위한 풀다운 메뉴를 제공하고 미리 설정이 되어 있다. 변경을 원한다면 프락시 이름, 아이피 주소, 포트 번호를 설정할 수 있다. 하지만 명시적 설정에는 두 가지 단점이 있다.

* 프락시가 응답하지 않으면 원 서버와도 접촉하지 않아 접속 문제를 경험하게 된다.
* 서버가 네트워크 아키텍처를 변경했을 때 모든 최종사용자에게 프락시 정보를 수정하도록 전파하는 것은 불가능하다.



### 20.5.2. 프락시 자동 설정

명시적 브라우저 설정이 사용자가 수동으로 네트워크 아키텍처 변경을 업데이트 하는 방식이었다면, 프락시 자동 설정은 브라우저가 동적으로 접촉해야 하는 프락시를 설정하는 방식이다. 이를 프락시 자동설정(PAC, Proxy Auto-configuration) 프로토콜이라 부른다.

브라우저는 URL 별로 접촉해야 하는 프락시를 지정한 PAC 파일을 찾는다. 먼저 지정된 서버에 접촉한 후 PAC 파일을 받아 재접속 할 때마다 PAC 파일의 정보를 통해 프락시에 연결한다. 

PAC 파일은 자바스크립트 파일로 다음의 함수를 통해 얻게된다.

`function FindProxyForURL(url, host)`

브라우저는 PAC 파일 안의 URL을 다음의 함수를 통해 호출한다.

`return_value = FindProxyForURL(url_of_request, host_in_url);`

반환된 값은 프락시들의 목록을 제시하거나 원서버로 바로 가야 하는 정보를 담을 수 있다. 프락시 목록은 `"PROXY proxy1.domain.com; PROXY proxy2.domian.com"` 
원서버 직행은 `DIRECT` 로 주어진다.

```
HTTP/1.0 200 OK
Content-type: applicaton/x-ns-proxy-autoconfig
Content-length: 176

function FindProxyForURL(url, host)
{
	if (dnsDomain(host, ".netscape.com"))
		return "DIRECT"
	else
		return "PROXY proxy1.joes-cache.com:8080; DIRECT";
}
```

> PAC파일을 포함한 서버의 응답
>
> 요청한 URL이 netscape.com 도메인 안에 있다면 원 서버에 바로 접근하고 아니면 proxy1로 가라고 말해주는 함수
>
> 브라우저는 이 함수를 호출하여 함수 반환 값에 따라 접속

PAC 프로토콜은 강력하다. 브라우저, DNS 주소, 서브넷, 요일, 시각 등의 매개변수에 근거하여 프락시를 다양하게 선택하도록 요구할 수 있다. 프락시 위치의 변경에 대해 PAC 파일을 서버가 업데이트하며 브라우저는 함수 호출을 통해 네트워크 아키텍처 변경에 맞는 프락시에 접촉할 수 있다.



### 20.5.3. 웹 프락시 자동발견 프로토콜 (WPAD)

웹 프락시 자동발견 프로토콜(WPAD, Web Proxy AutoDiscovery protocol)은 웹 브라우저가 PAC 파일의 URL을 얻어 프락시 정보를 획득하는 방식이다. 웹 프락시를 자동으로 발견하는 프로토콜은 여러 가지 존재하며 WPAD에 대한 프로토콜은 글 작성 기준 개발 중에 있다. 

* WPAD를 이용해 PAC 파일 CURL을 찾는다
* URL에 해당하는 PAC 파일[CFILE]을 가져온다
* 프락시 서버를 알아내기 위해 PAC 파일을 실행한다
* PAC 파일이 반환한 프락시 서버에 HTTP 요청을 보낸다

#### PAC 파일 자동 발견

WPAD는 PAC 파일의 위치인 URL을 알려주고 이를 이용해 프락시 서버의 이름을 알 수 있게 한다. PAC 파일에는 부하 균형, 서버 배열 요청 라우팅, 프락시 서버 보조를 위해 자동화 된 장애 시의 대체 작동과 같은 정보가 있기 때문에 프락시 서버를 바로 알려주는 것이 아니라 PAC파일을 알려주는 것이다.

#### WPAD 알고리즘

WPAD는 적절한 PAC 파일 CURL을 결정하기 위해 리소스 발견 기법을 사용한다.

* DHCP[ 동적 호스트 설정 프로토콜]
* SLP[서비스 위치 프로토콜]
* DNS에게 잘 알려진 호스트 명
* DNS의 SRV 레코드
* TXT 레코드의 DNS 서비스 URL들

DHCP, DNS A 룩업 이외 자세한 내용의 경우 명세를 참고한다.

#### DHCP 

DHCP 서버가 CURL을 저장하고 있는 경우에 동작 가능한 방식이다. DHCP 프로토콜은 다시 RFC 2131, 2132에 나와있다.  WPAD를 위한 DHCP 옵션 코드 252는 PAC 파일을 가리키는 URL을 포함한 문자열이다.

#### DNS A 룩업

DNS 서버에 프락시 서버의 IP 주소들이 반드시 저장되어야 동작 가능하다. WPAD 클라이언트는 A 레코드 룩업을 보내 CURL을 얻는다. DNS 룩업에 대한 설명은 RFC 2219를 참고한다. 

#### PAC 파일 가져오기

한번 후보 CURL이 생성되면 WPAD 클라이언트는 GET 요청을 만들어 PAC 파일을 가져온다.

#### WPAD의 실행 상황

* 웹 클라이언트가 시작될 떄 [첫 인스턴스 시작 때 사용, 이후 상속]
* 클라이언트 호스트 아이피 주소가 변경된 **네트워킹 스택**으로부터 어떤 언급이 있을 때

이 외에도 PAC 파일이 만료되거나 대체품을 제공하지 않을 때, 현재 PAC 파일을 무효화 하기로 결정했을 때 WPAD 프로토콜을 수행할 수 있다.

#### WPAD 스푸핑(spoofing)

wpad를 도메인 이름의 절대 표기 앞에 붙여 찾아내는 방식이다. 이는 악의적 사용자에 의해 프락시 설정이 유도될 수 있기 때문에 정정되었다고 한다.

#### 타임아웃

각 발견 단계마다 시간을 10초 이내로 제한할 수 있다. 하지만 무선네트워크와 같이 대역폭이 좁고 대기시간이 긴 경우 매우 큰 타임아웃을 사용할 수 있다.

#### 관리자를 위한 고려사항

클라이언트가 호환을 위해 구현해야 하는 알고리즘은 DHCP와 DNS A 레코드 검색이다. 관리자들 역시 이 둘 중 하나를 설정해야 한다.  WPAD 프로토콜은 클라이언트가 근처에 있는 프락시 서버를 찾도록 돕는 역할을 한다. 이 때 근접성을 결정하는 가능성은 다음과 같다.

* DHCP 서버들은 서브넷에 따라 다른 답을 돌려줘 클라이언트가 식별하게 한다.
* DNS 서버는 도메인 접미사에 따라 SRV/A/TXT 리소스 레코드를 반환하도록 설정한다.
* CURL 요청을 다루는 웹서버는 User-Agent헤더, Accpet헤더, 클라이언트 위치, 프락시 위상 기하학적 배치 등에 근거하여 결정을 내릴 수 있다.
* PAC 파일은 여러 대안 중 하나를 클라이언트에서 실시간으로 선택할 수 있을 만한 충분한 표현력을 갖고 있을 수도 있다. 가장 가깝거나 가장 반응이 빠른 서버를 선택하기 위해 네트워크 거리, 건강도를 측정할 수 있다.